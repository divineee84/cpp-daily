<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>cpp-daily — explorer</title>

  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/markdown.min.js"></script>

  <style>
    :root{
      --bg: #071024;
      --panel: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --muted: #9bb0bf;
      --accent: #4f8cff;
      --glass: rgba(255,255,255,0.03);
      --card-bg: rgba(255,255,255,0.02);
      --radius: 12px;
    }

    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: radial-gradient(1200px 600px at 10% 10%, rgba(79,140,255,0.06), transparent), var(--bg); color: #e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* centered page container */
    .page {
      max-width: 1200px;
      margin: 28px auto;
      padding: 20px;
      box-sizing: border-box;
      min-height: calc(100vh - 56px);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    header {
      display:flex;
      align-items:center;
      gap:16px;
      width:100%;
    }

    .logo {
      width:58px;
      height:58px;
      border-radius:12px;
      background: linear-gradient(135deg,#0ea5e9,#7c3aed);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:white;
      font-size:18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      flex-shrink:0;
    }

    .title-block {
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    h1 { margin:0; font-size:18px; letter-spacing: -0.2px; }
    .lead { margin:0; color:var(--muted); font-size:13px; max-width:780px; }

    .controls {
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .search {
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.03);
      background:var(--glass);
      color:inherit;
      min-width:240px;
      outline:none;
    }

    .btn {
      padding:8px 12px;
      border-radius:10px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
    }

    /* main grid */
    .main {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap:20px;
      align-items:start;
      width:100%;
      height: calc(100vh - 200px);
    }

    /* left file list */
    .left {
      background: var(--panel);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      overflow:auto;
      min-height: 280px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .search-hint { color:var(--muted); font-size:12px; margin-bottom:4px; }

    .day-card {
      padding:10px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));
      border:1px solid rgba(255,255,255,0.02);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .day-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(2,8,23,0.6); }
    .day-top { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .day-title { font-weight:700; font-size:14px; color:#eaf2ff; }
    .day-sub { font-size:12px; color:var(--muted); }

    .files { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .file { color:var(--accent); text-decoration:none; font-size:13px; display:inline-flex; gap:8px; align-items:center; }
    .file:hover { text-decoration: underline; }

    /* right viewer */
    .right {
      background: var(--panel);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 6px 24px rgba(2,6,23,0.55);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
      min-height: 280px;
    }

    .viewer-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      min-height:48px;
    }

    .viewer-title { font-weight:700; font-size:15px; color:#fff; }
    .viewer-meta { font-size:13px; color:var(--muted); }

    .code-wrap {
      flex:1;
      overflow:auto;
      border-radius:10px;
      background:#06070a;
      padding:12px;
      border:1px solid rgba(255,255,255,0.02);
    }

    pre { margin:0; font-size:13px; line-height:1.45; white-space:pre; tab-size:4; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; color:#e6eef6; }
    /* tiny pills */
    .pill { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:var(--muted); font-size:13px; cursor:pointer; }

    /* When no file selected */
    .empty-state { color:var(--muted); font-size:14px; padding:26px; text-align:center; }

    /* responsive */
    @media (max-width:980px){
      .main { grid-template-columns: 1fr; height: auto; }
      .left { order:2; }
      .right { order:1; height:auto; }
      .controls { margin-left:0; width:100%; justify-content:space-between; gap:8px; }
      .search{ min-width:140px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="logo">CPP</div>
      <div class="title-block">
        <h1>cpp-daily — explorer</h1>
        <p class="lead" id="desc">Loading...</p>
      </div>

      <div class="controls" role="toolbar" aria-label="controls">
        <input id="search" class="search" placeholder="Search days or files (enter)" />
        <button id="refreshBtn" class="btn" title="Reload data">Refresh</button>
        <button id="githubBtn" class="btn" title="Open repo on GitHub">Open on GitHub</button>
      </div>
    </header>

    <div class="main" role="main">
      <aside class="left" aria-label="days list">
        <div class="search-hint">Days — click to expand files</div>
        <div id="daysList">Loading days…</div>
      </aside>

      <section class="right" aria-label="code viewer">
        <div class="viewer-header">
          <div>
            <div class="viewer-title" id="viewerTitle">Pick a file to view</div>
            <div class="viewer-meta" id="viewerMeta">Repo: —</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="openRaw" class="pill" style="display:none">Open raw</div>
            <div id="openGit" class="pill" style="display:none">Open on GitHub</div>
            <div id="downloadFile" class="pill" style="display:none">Download</div>
          </div>
        </div>

        <div class="code-wrap" id="codeWrap">
          <pre><code id="codePre" class="hljs">No file selected — click any file on the left to preview its content here.</code></pre>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function(){
      let config = {
        title: "CPP Daily Log",
        description: "Daily C++ learning.",
        repo: "divineee84/cpp-daily",
        branch: "main",
        rootPath: "log",
        days: []
      };

      const daysListEl = document.getElementById('daysList');
      const descEl = document.getElementById('desc');
      const viewerTitle = document.getElementById('viewerTitle');
      const viewerMeta = document.getElementById('viewerMeta');
      const codePre = document.getElementById('codePre');
      const openRaw = document.getElementById('openRaw');
      const openGit = document.getElementById('openGit');
      const downloadFile = document.getElementById('downloadFile');
      const searchInput = document.getElementById('search');
      const githubBtn = document.getElementById('githubBtn');
      const refreshBtn = document.getElementById('refreshBtn');

      async function fetchApiJson(){
        try {
          const res = await fetch('api.json', {cache: "no-store"});
          if (!res.ok) throw new Error("no local api.json");
          const j = await res.json();
          config = Object.assign(config, j);
          return true;
        } catch(e){
          console.warn("api.json not found or failed to load:", e);
          return false;
        }
      }

      async function fetchFromGitHub(){
        const apiRoot = `https://api.github.com/repos/${config.repo}/contents/${config.rootPath}`;
        try {
          const res = await fetch(apiRoot);
          if (!res.ok) throw new Error('GitHub API error: ' + res.status);
          const data = await res.json();
          config.days = await Promise.all(data
            .filter(item => item.type === 'dir')
            .sort((a,b)=> a.name.localeCompare(b.name))
            .map(async dirItem => {
              const res2 = await fetch(dirItem.url);
              const arr = await res2.json();
              const files = arr.filter(x=> x.type === 'file').map(f => f.name);
              return {
                day: dirItem.name,
                title: dirItem.name,
                path: dirItem.path,
                files: files
              };
            })
          );
          return true;
        } catch(e){
          console.error("Failed to fetch from GitHub:", e);
          return false;
        }
      }

      function fileExtension(name){
        const m = name.match(/\.([a-z0-9]+)$/i);
        return m ? m[1].toLowerCase() : '';
      }

      function langClassFor(filename){
        const ext = fileExtension(filename);
        if (ext === 'cpp' || ext === 'cc' || ext === 'cxx') return 'cpp';
        if (ext === 'c' ) return 'c';
        if (ext === 'h' || ext === 'hpp') return 'cpp';
        if (ext === 'md' || ext === 'markdown') return 'markdown';
        if (ext === 'txt' ) return 'plaintext';
        return '';
      }

      function createDayCard(dayObj){
        const card = document.createElement('div');
        card.className = 'day-card';

        const top = document.createElement('div');
        top.className = 'day-top';

        const left = document.createElement('div');
        left.innerHTML = `<div class="day-title">${escapeHtml(dayObj.day)} — ${escapeHtml(dayObj.title || '')}</div>
                          <div class="day-sub">${dayObj.date ? escapeHtml(dayObj.date) : ''}</div>`;
        top.appendChild(left);

        card.appendChild(top);

        const filesWrap = document.createElement('div');
        filesWrap.className = 'files';
        (dayObj.files || []).forEach(f => {
          const a = document.createElement('a');
          a.className = 'file';
          a.textContent = f;
          a.href = 'javascript:void(0)';
          a.onclick = () => viewFile(dayObj.path + '/' + f, dayObj, f);
          filesWrap.appendChild(a);
        });
        card.appendChild(filesWrap);

        return card;
      }

      function escapeHtml(s){
        return (s+'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
      }

      function renderDays(filter = ''){
        daysListEl.innerHTML = '';
        const q = (filter || '').toLowerCase().trim();
        const filtered = config.days.filter(d => {
          if (!q) return true;
          if ((d.day || '').toLowerCase().includes(q)) return true;
          if ((d.title || '').toLowerCase().includes(q)) return true;
          if ((d.files||[]).some(f => f.toLowerCase().includes(q))) return true;
          return false;
        });

        if (filtered.length === 0){
          daysListEl.innerHTML = `<div style="color:var(--muted);padding:12px">No results</div>`;
          return;
        }

        filtered.forEach(d => daysListEl.appendChild(createDayCard(d)));
      }

      async function viewFile(relativePath, dayObj, filename){
        viewerTitle.textContent = `${filename} — ${dayObj.day}`;
        viewerMeta.textContent = `${config.repo} • ${dayObj.path}`;

        const rawUrl = `https://raw.githubusercontent.com/${config.repo}/${config.branch}/${relativePath}`;
        openRaw.style.display = 'inline-block';
        openGit.style.display = 'inline-block';
        downloadFile.style.display = 'inline-block';
        openRaw.onclick = ()=> window.open(rawUrl, '_blank');
        openGit.onclick = ()=> window.open(`https://github.com/${config.repo}/blob/${config.branch}/${relativePath}`, '_blank');
        downloadFile.onclick = ()=> {
          fetch(rawUrl).then(r=>r.blob()).then(blob=>{
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
          });
        };

        codePre.textContent = 'Loading file…';
        codePre.className = 'hljs';
        try {
          const r = await fetch(rawUrl);
          if (!r.ok) throw new Error('Failed to load file: '+r.status);
          const txt = await r.text();
          const lang = langClassFor(filename);
          codePre.className = lang ? `language-${lang} hljs` : 'hljs';
          codePre.textContent = txt;
          hljs.highlightElement(codePre);
        } catch(e){
          codePre.textContent = 'Could not load file. ' + e;
          codePre.className = 'hljs';
        }
      }

      async function init(){
        descEl.textContent = 'Loading…';
        const loadedLocalApi = await fetchApiJson();
        if (!loadedLocalApi){
          descEl.textContent = config.description || 'Auto-listing from GitHub';
          await fetchFromGitHub();
        } else {
          descEl.textContent = config.description || '';
        }
        document.title = (config.title || 'CPP Daily') + ' — explorer';
        viewerMeta.textContent = `Repo: ${config.repo} • branch: ${config.branch}`;
        githubBtn.onclick = ()=> window.open(`https://github.com/${config.repo}`, '_blank');
        renderDays();
      }

      searchInput.addEventListener('keydown', e=>{
        if (e.key === 'Enter'){
          renderDays(searchInput.value);
        }
      });

      refreshBtn.onclick = async ()=>{
        const hadLocal = await fetchApiJson();
        if (!hadLocal) {
          await fetchFromGitHub();
        }
        renderDays(searchInput.value);
      };

      init();

      window.cppDaily = { config, renderDays, viewFile };
    })();
  </script>
</body>
</html>
